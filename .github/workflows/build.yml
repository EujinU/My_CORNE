name: Build ZMK Firmware
on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:3.5
    name: Build Firmware

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup ZMK
        run: |
          west init -l config
          west update
          west zephyr-export

      - name: Build Left Side
        run: |
          echo "üî® Building left side..."
          west build -s zmk/app -b nice_nano_v2 \
            --build-dir build_left \
            -- -DSHIELD=corne_left \
               -DKEYMAP=corne_test \
               -DZMK_CONFIG="$(pwd)/config"

      - name: Build Right Side
        run: |
          echo "üî® Building right side..."
          west build -s zmk/app -b nice_nano_v2 \
            --build-dir build_right \
            -- -DSHIELD=corne_right \
               -DKEYMAP=corne_test \
               -DZMK_CONFIG="$(pwd)/config"

      - name: Prepare UF2 Files
        run: |
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ñ–∞–π–ª–æ–≤
          mkdir -p firmware_files
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ UF2 —Ñ–∞–π–ª—ã
          if [ -f "build_left/zephyr/zmk.uf2" ]; then
            cp "build_left/zephyr/zmk.uf2" "firmware_files/corne_left.uf2"
            echo "‚úÖ Left firmware: corne_left.uf2"
          else
            echo "‚ùå Left firmware not found!"
            ls -la build_left/zephyr/ || echo "build_left directory doesn't exist"
          fi
          
          if [ -f "build_right/zephyr/zmk.uf2" ]; then
            cp "build_right/zephyr/zmk.uf2" "firmware_files/corne_right.uf2"
            echo "‚úÖ Right firmware: corne_right.uf2"
          else
            echo "‚ùå Right firmware not found!"
            ls -la build_right/zephyr/ || echo "build_right directory doesn't exist"
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã
          echo "üìã Created files:"
          ls -la firmware_files/

      - name: Create ZIP Archive
        run: |
          # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ —Å –¥–∞—Ç–æ–π –≤ –∏–º–µ–Ω–∏
          DATE=$(date +'%Y%m%d_%H%M%S')
          ZIP_NAME="corne_firmware_${DATE}.zip"
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å —Ñ–∞–π–ª–∞–º–∏
          cd firmware_files
          
          # –°–æ–∑–¥–∞–µ–º ZIP –∞—Ä—Ö–∏–≤
          if [ "$(ls -1 *.uf2 2>/dev/null | wc -l)" -gt 0 ]; then
            zip "../${ZIP_NAME}" *.uf2
            echo "üì¶ Created archive: ${ZIP_NAME}"
            echo "ZIP_NAME=${ZIP_NAME}" >> $GITHUB_ENV
          else
            echo "‚ö†Ô∏è No UF2 files found to archive!"
            ls -la
            exit 1
          fi
          
          cd ..

      - name: Upload Firmware Archive
        uses: actions/upload-artifact@v4
        with:
          name: corne-firmware
          path: |
            corne_firmware_*.zip
          retention-days: 90

      - name: Create GitHub Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: corne_firmware_*.zip
          body: |
            Firmware for Corne keyboard with OLED and RGB underglow
            
            ## Flash instructions:
            1. Connect keyboard in bootloader mode (double-tap reset)
            2. Copy `.uf2` files to the USB drive
            3. Left side: `corne_left.uf2`
            4. Right side: `corne_right.uf2`
            
            ## Features:
            - OLED display support
            - RGB underglow
            - Encoder support on both sides
