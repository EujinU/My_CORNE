name: Build ZMK Firmware
on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    # Используем актуальный стабильный образ от ZMK
    container:
      image: zmkfirmware/zmk-build-arm:stable
    name: Build Firmware

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: 'my-config' # Клонируем репозиторий в подпапку

      - name: Prepare and Build
        run: |
          # Переходим в каталог клонированного репозитория
          cd my-config
          # Используем стандартную команду сборки ZMK
          # Она автоматически найдет config/ и build.yaml
          west init -l config
          west update
          west zephyr-export
          # Собираем все цели из build.yaml
          python3 -c "
import yaml, subprocess, sys
with open('build.yaml') as f:
    matrix = yaml.safe_load(f)['include']
for item in matrix:
    board = item['board']
    shield = item.get('shield', '')
    args = ['west', 'build', '-s', 'zmk/app', '-b', board, '--', '-DZMK_CONFIG=$(pwd)/config']
    if shield:
        args.append('-DSHIELD=' + shield)
    print(' '.join(args))
    subprocess.run(args, check=True)
          "
