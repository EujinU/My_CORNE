name: Build ZMK Firmware
on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:stable
    name: Build Firmware

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: 'my-config'

      - name: Prepare Workspace
        run: |
          cd my-config
          west init -l config
          west update
          west zephyr-export

      - name: Build Firmware
        run: |
          cd my-config
          # –ü—Ä–æ—á–∏—Ç–∞–µ–º build.yaml –∏ –ø–æ—Å—Ç—Ä–æ–∏–º –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Ü–µ–ª–∏
          BUILD_TARGETS=$(python3 -c "
import yaml, sys
with open('build.yaml') as f:
    data = yaml.safe_load(f)
for target in data.get('include', []):
    cmd = 'west build -s zmk/app -b {} -- -DZMK_CONFIG=$(pwd)/config'.format(target['board'])
    if 'shield' in target:
        cmd += ' -DSHIELD={}'.format(target['shield'])
    print(cmd)
          ")
          # –í—ã–ø–æ–ª–Ω–∏–º –∫–∞–∂–¥—É—é –∫–æ–º–∞–Ω–¥—É —Å–±–æ—Ä–∫–∏
          while IFS= read -r cmd; do
            echo "üöÄ –í—ã–ø–æ–ª–Ω—è—é: $cmd"
            eval $cmd
          done <<< "$BUILD_TARGETS"
