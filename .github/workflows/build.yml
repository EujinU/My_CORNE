name: Build ZMK Firmware
on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:3.5
    name: Build Firmware

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Prepare and Build
        id: build
        run: |
          # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ZMK
          west init -l config
          west update
          west zephyr-export
          
          # –ß—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ build.yaml
          MATRIX_JSON=$(python3 -c "import yaml, json, sys; print(json.dumps(yaml.safe_load(sys.stdin)['include']))" < build.yaml)
          
          # –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—É—Ç–µ–π –∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞–º
          ARTIFACT_PATHS=""
          
          echo "$MATRIX_JSON" | jq -c '.[]' | while read -r TARGET; do
            BOARD=$(echo "$TARGET" | jq -r '.board')
            SHIELD=$(echo "$TARGET" | jq -r '.shield // ""')
            KEYMAP=$(echo "$TARGET" | jq -r '.keymap // ""')
            
            # –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–±–æ—Ä–∫–∏
            BUILD_DIR_NAME="build_${BOARD}"
            if [ -n "$SHIELD" ]; then
              BUILD_DIR_NAME="${BUILD_DIR_NAME}_${SHIELD}"
            fi
            if [ -n "$KEYMAP" ] && [ "$KEYMAP" != "default" ]; then
              BUILD_DIR_NAME="${BUILD_DIR_NAME}_${KEYMAP}"
            fi
            
            echo "üîß –°–±–æ—Ä–∫–∞: BOARD=$BOARD, SHIELD=$SHIELD, KEYMAP=$KEYMAP"
            echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–±–æ—Ä–∫–∏: $BUILD_DIR_NAME"
            
            # –ö–æ–º–∞–Ω–¥–∞ —Å–±–æ—Ä–∫–∏
            CMD="west build -s zmk/app -b $BOARD --build-dir $BUILD_DIR_NAME -- -DZMK_CONFIG=$(pwd)/config"
            [ -n "$SHIELD" ] && CMD="$CMD -DSHIELD=$SHIELD"
            [ -n "$KEYMAP" ] && CMD="$CMD -DKEYMAP=$KEYMAP"
            
            echo "üöÄ –í—ã–ø–æ–ª–Ω—è–µ–º: $CMD"
            eval $CMD
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
            echo "üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ $BUILD_DIR_NAME/zephyr/:"
            ls -la "$BUILD_DIR_NAME/zephyr/" || echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            
            # –ò—â–µ–º —Ñ–∞–π–ª—ã –ø—Ä–æ—à–∏–≤–∫–∏
            for ext in uf2 hex bin; do
              FIRMWARE_FILE="$BUILD_DIR_NAME/zephyr/zmk.$ext"
              if [ -f "$FIRMWARE_FILE" ]; then
                echo "‚úÖ –ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª –ø—Ä–æ—à–∏–≤–∫–∏: $FIRMWARE_FILE"
                # –ö–æ–ø–∏—Ä—É–µ–º —Å –ø–æ–Ω—è—Ç–Ω—ã–º –∏–º–µ–Ω–µ–º
                OUTPUT_NAME="firmware_${BOARD}"
                [ -n "$SHIELD" ] && OUTPUT_NAME="${OUTPUT_NAME}_${SHIELD}"
                [ -n "$KEYMAP" ] && OUTPUT_NAME="${OUTPUT_NAME}_${KEYMAP}"
                OUTPUT_NAME="${OUTPUT_NAME}.$ext"
                
                cp "$FIRMWARE_FILE" "$OUTPUT_NAME"
                echo "üìÑ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –∫–∞–∫: $OUTPUT_NAME"
                ARTIFACT_PATHS="$ARTIFACT_PATHS $OUTPUT_NAME"
              fi
            done
            
            echo "---"
          done
          
          # –í—ã–≤–æ–¥–∏–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
          echo "üì¶ –ò—Ç–æ–≥–æ–≤—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–æ—à–∏–≤–∫–∏:"
          ls -la firmware_* 2>/dev/null || echo "‚ö†Ô∏è –§–∞–π–ª—ã –ø—Ä–æ—à–∏–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
          echo "ARTIFACTS_FOUND=$(ls firmware_* 2>/dev/null | wc -l)" >> $GITHUB_ENV

      - name: Debug - List All Files
        run: |
          echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
          find . -type f -name "*.uf2" -o -name "*.hex" -o -name "*.bin" | head -20
          echo ""
          echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–Ω—è:"
          ls -la
          echo ""
          echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å build:"
          find . -type d -name "build_*" | head -5

      - name: Upload Firmware Artifacts
        uses: actions/upload-artifact@v4
        if: env.ARTIFACTS_FOUND > 0
        with:
          name: zmk-firmware
          path: |
            firmware_*
          retention-days: 90

      - name: Upload Build Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-logs
          path: |
            build_*/zephyr/.config
            build_*/build.log
          retention-days: 7
