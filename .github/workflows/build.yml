name: Build ZMK Firmware
on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:stable
    name: Build Firmware

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Prepare and Build
        run: |
          # 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è workspace ZMK
          west init -l config
          west update
          west zephyr-export

          # 2. –ß—Ç–µ–Ω–∏–µ build.yaml –∏ —Å–±–æ—Ä–∫–∞ –∫–∞–∂–¥–æ–π —Ü–µ–ª–∏
          # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º YAML –≤ JSON –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ bash/jq
          MATRIX_JSON=$(python3 -c "import yaml, json, sys; print(json.dumps(yaml.safe_load(sys.stdin)['include']))" < build.yaml)

          # 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–π —Ü–µ–ª–∏ —Å–±–æ—Ä–∫–∏ —Å –ø–æ–º–æ—â—å—é jq (–µ—Å–ª–∏ –Ω–µ—Ç jq, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å python)
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º jq, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç –≤ –æ–±—Ä–∞–∑–µ (–æ–±—ã—á–Ω–æ –æ–Ω –µ—Å—Ç—å)
          if ! command -v jq &> /dev/null; then apt-get update && apt-get install -y jq; fi

          echo "$MATRIX_JSON" | jq -c '.[]' | while read -r TARGET; do
            BOARD=$(echo "$TARGET" | jq -r '.board')
            SHIELD=$(echo "$TARGET" | jq -r '.shield // ""')

            CMD="west build -s zmk/app -b $BOARD -- -DZMK_CONFIG=$(pwd)/config"
            if [ -n "$SHIELD" ]; then
              CMD="$CMD -DSHIELD=$SHIELD"
            fi

            echo "üöÄ –°–±–æ—Ä–∫–∞: $CMD"
            eval $CMD
          done
