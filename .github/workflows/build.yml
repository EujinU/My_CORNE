name: Build ZMK Firmware
on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:3.2  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é
    name: Build Firmware

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install missing Python dependencies
        run: |
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          apt-get update
          apt-get install -y python3-distutils
          python3 -m pip install -U pip setuptools

      - name: Setup ZMK
        run: |
          west init -l config
          west update
          west zephyr-export

      - name: Build Both Sides
        run: |
          echo "üî® Building left side..."
          west build -s zmk/app -b nice_nano_v2 \
            --build-dir build_left \
            -- -DSHIELD=corne_left \
               -DZMK_CONFIG="$(pwd)/config"
          
          echo "üî® Building right side..."
          west build -s zmk/app -b nice_nano_v2 \
            --build-dir build_right \
            -- -DSHIELD=corne_right \
               -DZMK_CONFIG="$(pwd)/config"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
          echo "üìã Files in build_left:"
          find build_left -name "*.uf2" -o -name "zmk.*" | head -10
          
          echo "üìã Files in build_right:"
          find build_right -name "*.uf2" -o -name "zmk.*" | head -10

      - name: Prepare UF2 Files
        run: |
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
          mkdir -p firmware
          
          # –ö–æ–ø–∏—Ä—É–µ–º UF2 —Ñ–∞–π–ª—ã
          if [ -f "build_left/zephyr/zmk.uf2" ]; then
            cp "build_left/zephyr/zmk.uf2" "firmware/corne_left.uf2"
            echo "‚úÖ Left: firmware/corne_left.uf2"
          else
            echo "‚ùå Left UF2 not found!"
            ls -la build_left/zephyr/ || true
          fi
          
          if [ -f "build_right/zephyr/zmk.uf2" ]; then
            cp "build_right/zephyr/zmk.uf2" "firmware/corne_right.uf2"
            echo "‚úÖ Right: firmware/corne_right.uf2"
          else
            echo "‚ùå Right UF2 not found!"
            ls -la build_right/zephyr/ || true
          fi
          
          echo "üì¶ –í—Å–µ —Ñ–∞–π–ª—ã:"
          ls -la firmware/

      - name: Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: corne-firmware
          path: firmware/
          if-no-files-found: error
          retention-days: 90
