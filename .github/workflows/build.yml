name: Build ZMK Firmware
on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:3.5
    name: Build Firmware

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Prepare and Build
        id: build
        run: |
          west init -l config
          west update
          west zephyr-export
          MATRIX_JSON=$(python3 -c "import yaml, json, sys; print(json.dumps(yaml.safe_load(sys.stdin)['include']))" < build.yaml)
          echo "$MATRIX_JSON" | jq -c '.[]' | while read -r TARGET; do
            BOARD=$(echo "$TARGET" | jq -r '.board')
            SHIELD=$(echo "$TARGET" | jq -r '.shield // ""')
            KEYMAP=$(echo "$TARGET" | jq -r '.keymap // ""')
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð¼Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸
            BUILD_DIR="build"
            if [ -n "$SHIELD" ]; then
              BUILD_DIR="${BUILD_DIR}_${BOARD}_${SHIELD}"
              if [ -n "$KEYMAP" ]; then
                BUILD_DIR="${BUILD_DIR}_${KEYMAP}"
              fi
            else
              BUILD_DIR="${BUILD_DIR}_${BOARD}"
            fi
            
            CMD="west build -s zmk/app -b $BOARD --build-dir $BUILD_DIR -- -DZMK_CONFIG=$(pwd)/config"
            [ -n "$SHIELD" ] && CMD="$CMD -DSHIELD=$SHIELD"
            [ -n "$KEYMAP" ] && CMD="$CMD -DKEYMAP=$KEYMAP"
            
            echo "ðŸš€ Ð¡Ð±Ð¾Ñ€ÐºÐ°: $CMD"
            eval $CMD
            
            # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸ Ð² ÑƒÐ´Ð¾Ð±Ð½Ð¾Ðµ Ð¼ÐµÑÑ‚Ð¾
            if [ -f "$BUILD_DIR/zephyr/zmk.uf2" ]; then
              cp "$BUILD_DIR/zephyr/zmk.uf2" "firmware_${BOARD}_${SHIELD}_${KEYMAP}.uf2"
              echo "âœ… UF2 Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½"
            fi
            if [ -f "$BUILD_DIR/zephyr/zmk.hex" ]; then
              cp "$BUILD_DIR/zephyr/zmk.hex" "firmware_${BOARD}_${SHIELD}_${KEYMAP}.hex"
              echo "âœ… HEX Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½"
            fi
            if [ -f "$BUILD_DIR/zephyr/zmk.bin" ]; then
              cp "$BUILD_DIR/zephyr/zmk.bin" "firmware_${BOARD}_${SHIELD}_${KEYMAP}.bin"
              echo "âœ… BIN Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½"
            fi
          done
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
          ls -la firmware_* 2>/dev/null || echo "Ð¤Ð°Ð¹Ð»Ñ‹ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"
          
          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ ÑˆÐ°Ð³Ð°
          echo "firmware_files=$(ls firmware_* 2>/dev/null | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Upload Firmware Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware
          path: |
            firmware_*
            build_*/zephyr/zmk.*
          retention-days: 7

      - name: List Artifacts
        run: |
          echo "Ð¡Ð¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹:"
          ls -la firmware_* 2>/dev/null || echo "Ð¤Ð°Ð¹Ð»Ñ‹ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"
