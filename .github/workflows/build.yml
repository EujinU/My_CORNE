name: Build ZMK Firmware
on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:3.5  # <- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½ÑƒÑŽ, Ð±Ð¾Ð»ÐµÐµ Ð½Ð¾Ð²ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ
    name: Build Firmware

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Prepare and Build
        run: |
          west init -l config
          west update
          west zephyr-export
          MATRIX_JSON=$(python3 -c "import yaml, json, sys; print(json.dumps(yaml.safe_load(sys.stdin)['include']))" < build.yaml)
          echo "$MATRIX_JSON" | jq -c '.[]' | while read -r TARGET; do
            BOARD=$(echo "$TARGET" | jq -r '.board')
            SHIELD=$(echo "$TARGET" | jq -r '.shield // ""')
            CMD="west build -s zmk/app -b $BOARD -- -DZMK_CONFIG=$(pwd)/config"
            [ -n "$SHIELD" ] && CMD="$CMD -DSHIELD=$SHIELD"
            echo "ðŸš€ Ð¡Ð±Ð¾Ñ€ÐºÐ°: $CMD"
            eval $CMD
          done
